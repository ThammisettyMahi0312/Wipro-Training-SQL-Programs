-- Switch to master to avoid 'database in use' error while dropping
USE master;
GO

-- Terminate existing connections and drop the database safely
IF EXISTS (SELECT name FROM sys.databases WHERE name = 'wiprojuly')
BEGIN
    ALTER DATABASE wiprojuly SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
    DROP DATABASE wiprojuly;
END
GO

-- Create the new database
CREATE DATABASE wiprojuly;
GO

-- Use the newly created database
USE wiprojuly;
GO

-- Drop LeaveHistory table if it exists
IF OBJECT_ID('LeaveHistory', 'U') IS NOT NULL
    DROP TABLE LeaveHistory;
GO

-- Drop Employ table if it exists
IF OBJECT_ID('Employ', 'U') IS NOT NULL
    DROP TABLE Employ;
GO

-- Create Employ table
CREATE TABLE Employ (
    Empno INT CONSTRAINT pk_employ_empno PRIMARY KEY,
    Name VARCHAR(30) NOT NULL,
    Gender VARCHAR(10) CONSTRAINT chk_employ_gender CHECK (Gender IN ('MALE', 'FEMALE')),
    Dept VARCHAR(30) CONSTRAINT chk_employ_dept CHECK (Dept IN ('Dotnet', 'Java', 'Python')),
    Desig VARCHAR(30) NOT NULL,
    Basic NUMERIC(9, 2) CONSTRAINT chk_employ_basic CHECK (Basic BETWEEN 10000 AND 90000)
);
GO

-- Insert records into Employ
INSERT INTO Employ (Empno, Name, Gender, Dept, Desig, Basic)
VALUES 
    (1, 'Yamini', 'FEMALE', 'Dotnet', 'Expert', 88222),
    (2, 'Anusha', 'FEMALE', 'Java', 'Manager', 82222),
    (3, 'Uday', 'MALE', 'Python', 'Expert', 68833),
    (4, 'Datta', 'MALE', 'Dotnet', 'Manager', 88322),
    (5, 'Mahi', 'FEMALE', 'Python', 'Expert', 88223);
GO

-- Create LeaveHistory table
CREATE TABLE LeaveHistory (
    LeaveId INT IDENTITY(1,1) CONSTRAINT pk_leaveHistory_leaveId PRIMARY KEY,
    EmpNo INT CONSTRAINT FK_Employ_Empno FOREIGN KEY (EmpNo) REFERENCES Employ(EmpNo),
    LeaveStartDate DATE,
    LeaveEndDate DATE,
    noOfDays AS DATEDIFF(DAY, LeaveStartDate, LeaveEndDate) PERSISTED,
    LossOfPay NUMERIC(9, 2)
);
GO

-- Insert records into LeaveHistory
INSERT INTO LeaveHistory (EmpNo, LeaveStartDate, LeaveEndDate)
VALUES 
    (1, '2025-08-02', '2025-08-05'),
    (2, '2025-09-03', '2025-09-22');
GO
